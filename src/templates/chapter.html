<!DOCTYPE html>
<html>
<head>
    <title>{{ chapter.title }} of {{ book.name }} Read Online Free - {{ sitename }}</title>
    {% include 'common/head_meta.html' %}
</head>
<body class="{% if user_settings.darkMode == 'dark' %}bg-dark text-light{% endif %}" style="font-size: {{ user_settings.fontSize }};">

{% include 'common/navbar.html' %}

<main>
    <section class="text-center mt-5">
        <a href="{{ url_for('get_book', book_slug=book.slug) }}" class="text-muted">
            {{ book.name }}
        </a>
    </section>

    <article class="container box mt-2 mb-4" id="chapter-main" data-chapter-no="{{ chapter.no }}"
         data-book-slug="{{ book.slug }}">
        {{ content|safe }}
    </article>

    <section class="container mt-4 mb-5 d-flex justify-content-center box">
        {% if prev_chapter_url %}
            <a href="{{ prev_chapter_url }}" class="me-3">Prev</a>
        {% endif %}

        <span class="d-block mx-3"></span>

        {% if next_chapter_url %}
            <a href="{{ next_chapter_url }}">Next</a>
        {% endif %}
    </section>
</main>

{% include 'common/footer.html' %}
<script>
    for (var i = 0; i < wordEls.length; i++) {
        wordEls[i].addEventListener('click', function () {
            var to_lang = document.getElementById('language-selector').value;
            if (!to_lang) {
                alert('Please select target language at top right');
                return;
            }
            offcanvasTitleEl.innerHTML = 'Searching...';
            offcanvasContentEl.innerHTML = '';
            OFFCANVAS_INSTANCE.show();
            searchDictionary(offcanvasTitleEl, offcanvasContentEl, this.innerText, to_lang);
        });
    }

    // Track scroll position and save progress when the user scrolls or leaves the page
    window.addEventListener('scroll', () => {
        saveReadingProgress(bookSlug, chapterNo, getFirstVisibleSentenceId());
    });

    Array.from(sentenceButtonEls).forEach(function (p) {
        p.addEventListener('click', function (event) {
            p.classList.add('clicked');
            var sentenceEl = event.currentTarget.parentElement;
            var sentenceNo = event.currentTarget.getAttribute('id');

            offcanvasTitleEl.innerHTML = '';
            offcanvasContentEl.innerHTML = '';

            const titleDiv = document.createElement('div');
            titleDiv.classList.add('d-flex', 'justify-content-center');

            const button = document.createElement('button');
            button.innerText = 'Translate';
            button.classList.add("btn", "btn-sm", "btn-outline-secondary", "me-2");
            titleDiv.appendChild(button);

            offcanvasTitleEl.appendChild(titleDiv);

            // remove sentence no
            offcanvasContentEl.innerHTML = sentenceEl.innerHTML;
            OFFCANVAS_INSTANCE.show();

            button.addEventListener('click', function () {
                translateSentence(button, sentenceNo, offcanvasContentEl);
            });
        });
    });

</script>
</body>
</html>
